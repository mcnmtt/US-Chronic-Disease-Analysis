---
title: "R Notebook"
output: html_notebook
---

Addestriamo una **Random Forest di classificazione** con 300 alberi (`ntree=300`), cercando di prevedere la variabile target `stratification1` (le etnie) a partire da:

-   `datavalue`

-   `questionid`

-   `datavaluetypeid`

-   `datavalueunit`

-   `topic`

In pratica, il modello deve provare a capire **a quale gruppo etnico appartiene un record**.

### Filtro topic (Diabetes & Cardiovascular Disease)

```{r}
library(dplyr)

dataset_path <- "u_s_chronic_disease_indicators_cdi.csv"

df <- read.csv(dataset_path, na.strings = c("", "NA", "NULL", "null"))

df_filtered <- df %>%
  filter(topic %in% c("Diabetes", "Cardiovascular Disease"))
```

```{r}
library(dplyr)         # gestione dati
library(randomForest)  # random forest

df_sup <- df_filtered %>%
  filter(stratificationcategory1 == "Race/Ethnicity") %>%                    # tiene solo race/ethnicity
  mutate(
    datavalue_num = suppressWarnings(as.numeric(gsub(",", ".", datavalue, fixed = TRUE))), # converte valori numerici
    stratification1 = factor(stratification1)                               # target come fattore
  ) %>%
  select(stratification1, topic, questionid, datavaluetypeid, datavalueunit, datavalue_num) # variabili utili

df_sup <- df_sup %>%
  mutate(                                                                   # codifica categoriche
    topic = factor(topic),
    questionid = factor(questionid),
    datavaluetypeid = factor(datavaluetypeid),
    datavalueunit = factor(datavalueunit)
  )

df_sup <- na.omit(df_sup)                                                   # rimuove NA

set.seed(123)
train_idx <- sample(seq_len(nrow(df_sup)), size = 0.7 * nrow(df_sup))       # split 70/30
train <- df_sup[train_idx, ]
test  <- df_sup[-train_idx, ]

rf_model <- randomForest(                                                   # addestra random forest
  stratification1 ~ .,
  data = train,
  ntree = 300,
  mtry = 3,
  importance = TRUE
)

print(rf_model)                                                             # stampa modello

pred <- predict(rf_model, newdata = test)                                   # predizioni test

acc <- mean(pred == test$stratification1)                                   # accuracy
cat("Accuracy sul test set:", round(acc * 100, 2), "%\n")

importance(rf_model)                                                        # importanza variabili
varImpPlot(rf_model)                                                        # grafico importanza

```

# Interpretazione dei risultati

## Errori e accuratezza

**OOB estimate error rate = 44.98%** → significa che il modello sbaglia quasi il 45% dei casi già sul training, quindi è **moderatamente debole**.

**Accuracy sul test = 55.18%** → su dati mai visti indovina poco più della metà dei casi, quindi meglio del caso (che sarebbe ≈14% con 7 classi), ma non eccellente.

Questo ci dice che:

-   I gruppi etnici non sono separabili in modo netto solo con le variabili usate.
-   Probabilmente alcuni gruppi hanno pattern simili → il modello li confonde.

## Confusion Matrix

-   **White, non-Hispanic**: 3.973 correttamente predetti, errore \~16% → il modello riconosce abbastanza bene questo gruppo.

-   **Black, non-Hispanic**: errore \~54%

-   **Hispanic**: errore \~57%

-   **Asian or Pacific Islander**: errore \~47%

-   **American Indian or Alaska Native**: errore \~76%

-   **Multiracial** e **Other**: errore oltre 90% → quasi mai riconosciuti correttamente.

### Intepretazione

-   Il modello riesce soprattutto a distinguere bene i **White, non-Hispanic** (probabilmente perché più rappresentati nei dati).

-   Gruppi **minoritari** (es. American Indian, Multiracial, Other) vengono confusi quasi sempre, perché hanno pochi record e valori sovrapposti.

-   Gruppi **Black** e **Hispanic** hanno una certa separabilità, ma vengono confusi spesso tra loro.

Tutto ciò indica che in piccola parte sono presenti dei pattern diversi tra gruppi etnici rispetto ai fenomeni sanitari ma la bassa accuratezza indica che i gruppi minoritari hanno pochi dati e sono difficili da distinguere e spesso ci sono sovrapposizioni tra i valori → etnie diverse possono avere andamenti simili sugli indicatori considerati.
